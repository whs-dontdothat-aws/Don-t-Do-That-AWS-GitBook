# 로그 그룹 삭제 또는 변경 탐지

**\[ 목차 ]**

***

### **\[ 시나리오 안내 ]**

|        |                                                                                                                                                                                        |
| ------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 내용     | 공격자가 분석 회피를 위해 로그 그룹을 삭제하거나 로그 수집을 변경하는 시도 탐지합니다.                                                                                                                                      |
| 사용 서비스 | CloudTrail, EventBridge, SNS                                                                                                                                                           |
| 탐지 조건  | <p>1. 로그 그룹에 대해서 정책을 삭제하거나 구성을 변경하려는 시도를 탐지합니다.<br>2. DeleteLogGroup, PutRetentionPolicy 등 다양한 조건을 사전 학습하여 어떤 행위가 로그 그룹에 영향을 미칠 수 있는지 검토합니다.<br>3. 해당 조건을 토대로 로그 그룹에 대한 알람을 진행합니다.</p> |
| 알림 방식  | SNS + Email 및 Discord 전송                                                                                                                                                               |

#### 실습 개요

* 이 워크북에서는 로그 그룹이 삭제되거나 구성이 변경 되었을 때 자동 탐지하고 알림을 받는 방법을 학습합니다.
* 로그 그룹은 CloudWatch Log를 그룹화해 관리하는 논리적 컨테이너입니다. 삭제 시 분석 회피를 위한 악성 행위로 간주할 수 있습니다.
* 본 워크북에서는 CloudTrail과 EventBridge, SNS 등을 활용해 로그 그룹 삭제/변경 이벤트 발생 시 이메일 및 디스코드 알림을 받도록 구현하는 방법을 실습합니다.

#### 학습 목표

* AWS에서 로그 그룹의 삭제 및 변경 이벤트를 탐지하는 방법을 학습합니다.
* CloudTrail과 EventBridge를 활용해 이벤트를 수집하고, 이를 SNS와 연동하여 이메일 및 디스코드 알림을 전송하는 실습을 진행합니다.
* 이벤트에 대한 탐지 조건을 JSON 코드로 정의하여 실시간 대응 체계를 구축하는 과정을 이해합니다.
* 실제로 로그 그룹을 생성한 뒤 삭제하거나 변경하여 이벤트 탐지가 정상적으로 동작하는지 실습을 통해 검증합니다.

***

### **\[ 시나리오 전체적인 흐름 ]**

<figure><img src="detection-and-alert-scenarios/root-account-login-alert/docs/.gitbook/assets/image (55).png" alt=""><figcaption></figcaption></figure>

| **AWS Service** | **Service Purpose**                                                                                                            | **Workbook Usage**                                                                                                       |
| --------------- | ------------------------------------------------------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------ |
| CloudTrail      | AWS 계정 내에서 발생하는 모든 API 호출 이벤트를 기록하는 서비스입니다. 사용자의 콘솔 작업, AWS CLI, SDK, 서비스 간 호출 등 모든 요청을 JSON 로그 형식으로 저장하며, 보안 및 감사 목적으로 활용됩니다. | 로그 그룹을 변경하거나 삭제하는 API 이벤트인 `DeleteLogGroup`, `PutRetentionPolicy` 를 기록합니다.                                               |
| EventBridge     | AWS 서비스 및 애플리케이션에서 사용자가 정의한 이벤트가 발생하는 경우 다양한 대상 서비스(Lambda, SNS 등)로 전달하는 서비스 입니다.복잡한 이벤트 버스를 구현하거나 스케쥴링 기능으로도 활용할 수 있습니다.      | CloudTrail이 기록한 이벤트 로그 중 작성한 이벤트 패턴과 일치하는 이벤트를 **실시간으로 탐지**하기 위해 사용합니다.                                                  |
| SNS             | 발행-구독 기반의 메시징 서비스 입니다.이벤트를 HTTP, HTTPS, Email, SMS, Lambda, SQS 등 다양한 엔드포인트로 전달할 수 있습니다.                                       | CloudWatch 삭제, 보존 기간 변경 등 이벤트가 발생했을 때, 이를 **Email로 관리자에게 자동 통보**하기 위해 SNS 주제를 생성하고, 알림을 전송 받기 위해 해당 주제를 구독한 Email을 인증합니다 |
| Lambda          | 서버를 프로비저닝하거나 관리할 필요 없이 코드를 실행할 수 있는 서버리스 컴퓨팅 서비스입니다.다양한 이벤트 소스(S3, Eventbridge, SNS 등)와 연동하여 이벤트에 대한 응답으로 코드를 실행할 수 있습니다.      | SNS의 주제와 연동하여 이벤트가 발생하면 작성된 Lambda 함수를 통해 Discord로 알림을 보내주도록 설정합니다.                                                      |
| LogGroup        | CloudTrail 이벤트 로그를 저장하고 모니터링하는 CloudWatch Log를 그룹화해 관리하는 논리적 컨테이너입니다. 모니터링, 접근제어 등 설정을 공유할 수 있습니다.                             | 공격자가 분석 회피를 위해 로그 그룹을 삭제하거나 로그 보존 기간을 변경하는 대상입니다.                                                                        |

#### 참고 사항

* 본 워크북에서 생성되는 리소스 중 일부는 Terraform code를 통해 제공되고 있습니다.
* 주요 리소스에 대한 사전 구성을 필요로 하는 경우 하단의 “xx. Terraform으로 리소스 구현” 에서 내용을 참고하실 수 있습니다.
* 본 서비스의 주요 리소스는 “ap-northeast-2(Seoul)”에서 리전에서 진행됩니다. 주요 서비스 및 기능은 제공되는 서비스 리전에 따라 다를 수 있습니다.
* 리소스명은 해당 시나리오에 맞게 임의로 설정하였으며 사용자가 원하는 이름으로 바꿔도 무방합니다.

**\[ 콘솔 리소스명 ]**

| **리소스 종류**           | **리소스명 설정**                       | **목적**                                             |
| -------------------- | --------------------------------- | -------------------------------------------------- |
| CloudTrail Trail     | **`ct-trail-monitor`**            | AWS 계정 내 API 활동을 감시하고 로그를 S3로 저장                   |
| Discord 채널           | **`log-group-alarm`**             | SNS에 연동된 Lambda 함수를 통해 알림 메시지를 수신하고 확인할 수 있는 알림 채널 |
| Lambda Function      | **`lambda-loggroup-alarm`**       | SNS 메시지를 파싱하여 Discord Webhook으로 이상 행위 알림 전송        |
| SNS Topic            | **`sns-loggroup-alarm`**          | 이벤트 발생 시 이메일 및 Lambda로 알림을 전송하는 주제                 |
| EventBridge Rule     | **`eventbridge-loggroup-change`** | 특정 CloudTrail 이벤트 발생 시 SNS로 이벤트 전송하는 트리거 역할        |
| CloudWatch Log Group | **`loggroup-test`**               | 로그 그룹 삭제 및 변경 시 알림이 발생하는지 확인하기 위해 생성하는 테스트리소스      |

